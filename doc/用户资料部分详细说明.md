# 用户资料模块详细说明

本说明文档基于当前后端实现，全面梳理用户资料（UserProfile）相关功能、接口、数据结构、分层设计、权限校验、异常处理等。

---

## 1. 业务逻辑与结构

- 支持获取、更新用户个人资料。
- 资料更新需校验权限，仅允许本人操作。
- 用户资料与 UserProfile 实体关联，支持昵称、头像、背景、性别等字段。

---

## 2. 主要实体与DTO结构

### 2.1 UserProfile 实体
- id: Long
- user: User
- nickname: String
- avatarUrl: String
- backgroundUrl: String
- gender: String

### 2.2 UserProfileDTO
```json
{
  "id": 1,
  "nickname": "昵称",
  "avatarUrl": "头像URL",
  "backgroundUrl": "背景URL",
  "gender": "男/女"
}
```

---

## 3. 主要接口设计（UserController）

| 方法 | 路径 | 说明 | 请求体/参数 | 返回 |
|------|------|------|-------------|------|
| GET | /api/user/profile/{userId} | 获取用户资料 | userId | ApiResponse<UserProfileDTO> |
| PUT | /api/user/profile/{userId} | 更新用户资料 | userId, UserProfileDTO | ApiResponse<Void> |

---

## 4. Service 层接口

```java
public interface UserService {
    UserProfileDTO getUserProfileDTO(Long userId);
    boolean updateUserProfile(Long userId, UserProfileDTO dto);
}
```

---

## 5. 主要实现逻辑说明
- **getUserProfileDTO**：根据 userId 查询资料，封装为 DTO。
- **updateUserProfile**：校验权限，仅允许本人更新，更新资料。

---

## 6. Controller 典型代码片段

```java
@RestController
@RequestMapping("/api/user")
public class UserController {
    @Autowired
    private UserService userService;

    @GetMapping("/profile/{userId}")
    public ApiResponse<UserProfileDTO> getProfile(@PathVariable Long userId) {
        UserProfileDTO dto = userService.getUserProfileDTO(userId);
        if (dto == null) {
            return new ApiResponse<>(404, "用户信息不存在", null);
        }
        return new ApiResponse<>(200, "获取成功", dto);
    }

    @PutMapping("/profile/{userId}")
    public ApiResponse<Void> updateProfile(@PathVariable Long userId,
                                           @RequestBody UserProfileDTO userProfileDTO,
                                           @AuthenticationPrincipal UserDetails principal) {
        if (principal == null || !principal.getUsername().equals(userService.getUsernameById(userId))) {
            return new ApiResponse<>(403, "无权修改他人资料", null);
        }
        boolean ok = userService.updateUserProfile(userId, userProfileDTO);
        return ok ? new ApiResponse<>(200, "更新成功", null)
                : new ApiResponse<>(400, "更新失败", null);
    }
}
```

---

## 7. 权限、异常处理
- 资料更新需校验用户身份，仅本人可操作。
- 所有接口返回统一 ApiResponse<T>，包含 code/msg/data。
- 全局异常由 GlobalExceptionHandler 统一处理，参数校验失败自动返回 400，业务异常抛出 BusinessException。

---

## 8. 其他说明
- 支持后续扩展（如资料字段扩展、资料审核等）。
- DTO 仅暴露必要字段，防止敏感信息泄漏。

---

如需详细代码实现，请查阅 `service/impl/UserServiceImpl.java`、`controller/UserController.java`、`model/UserProfile.java`、`dto/UserProfileDTO.java`、`repository/UserProfileRepository.java` 等文件。
