# 用户资料部分详细说明

本说明文档详细分析本项目后端关于用户资料相关功能的实现机制，涵盖通信流程、文件间交互、前后端链接、全局异常处理、统一API响应格式，以及各层次的功能与通信过程。内容参考了《登录注册部分详细说明》，并结合实际代码实现。

---

## 1. 通信流程与前后端链接

### 1.1 获取用户资料流程
- **前端**向`/api/user/profile/{userId}`发送GET请求，路径参数为用户ID。
- **后端**`UserController`接收请求，调用`UserService.getUserProfileDTO(userId)`获取用户资料。
- 若用户存在，返回统一格式的`ApiResponse<UserProfileDTO>`，code为200，msg为“获取成功”；否则返回404和提示信息。

### 1.2 更新用户资料流程
- **前端**向`/api/user/profile/{userId}`发送PUT请求，Body为JSON格式的`UserProfileDTO`（包含昵称、头像、背景、性别等）。
- **后端**`UserController`接收请求，调用`UserService.updateUserProfile(userId, userProfileDTO)`进行业务处理。
- 更新成功后，返回统一格式的`ApiResponse<Void>`，code为200，msg为“更新成功”；失败则返回400和提示信息。

---

## 2. 文件间交互与各层功能

### 2.1 Controller层
- 负责接收前端请求、参数校验、调用Service层、返回统一响应。
- 主要文件：`UserController.java`
  - 负责`/api/user/profile`相关接口的路由与响应。

### 2.2 Service层
- 负责业务逻辑处理，如用户资料查询、更新等。
- 主要文件：`UserService.java`
  - `getUserProfileDTO(userId)`：根据ID查询用户资料，封装为DTO。
  - `updateUserProfile(userId, userProfileDTO)`：更新用户资料。

### 2.3 DTO层
- 用于数据传输和参数校验。
- 主要文件：
  - `UserProfileDTO.java`：用户资料参数与返回结构。

### 2.4 Common层
- 提供通用工具和统一响应、异常处理。
- 主要文件：
  - `ApiResponse.java`：统一API响应格式。
  - `GlobalExceptionHandler.java`：全局异常处理。

---

## 3. 统一API响应格式（ApiResponse）
- 所有接口返回`ApiResponse<T>`对象，包含：
  - `code`：状态码（如200、400、404等）
  - `msg`：提示信息
  - `data`：数据内容（如用户资料DTO，更新无数据则为null）
- 便于前端统一处理响应。

---

## 4. 全局异常处理
- `GlobalExceptionHandler`统一处理参数校验异常、业务异常、未知异常。
- 参数校验失败时，自动返���400和详细错误信息。
- 业务异常（如用户不存在、更新失败等）抛出`BusinessException`，由全局异常处理器捕获并返回友好提示。
- 未知异常返回500和通用错误信息，避免泄露敏感信息。

---

## 5. 各层通信与流程图解

1. **前端**发起请求（获取/更新用户资料）
2. **Controller**接收请求，参数校验
3. **Service**执行业务逻辑（如查库、更新）
4. **DTO**用于数据传递与校验
5. **Repository/Mapper**负责数据库操作
6. **Common**层提供工具与统一响应
7. **异常**由全局处理器统一捕获
8. **Controller**返回统一格式响应给前端

---

## 6. 形象说明

- **获取资料流程**：
  1. 前端请求用户资料
  2. 后端查找用户，封装DTO
  3. 返回资料或不存在提示

- **更新资料流程**：
  1. 前端填写资料，发起更新
  2. 后端校验、更新数据库
  3. 返回成功或失败原因

- **异常处理**：
  - 格式错误、业务冲突、系统异常均有详细提示，前端可据此友好展示

- **统一响应**：
  - 所有接口返回结构一致，便于前端统一处理

---

## 7. 关键代码片段举例

- **ApiResponse**
```java
public class ApiResponse<T> {
    private int code;
    private String msg;
    private T data;
    // ... 构造方法、getter/setter ...
}
```
- **全局异常处理**
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ApiResponse<Void> handleValidationException(MethodArgumentNotValidException ex) { ... }
    @ExceptionHandler(BusinessException.class)
    public ApiResponse<Void> handleBusinessException(BusinessException ex) { ... }
    @ExceptionHandler(Exception.class)
    public ApiResponse<Void> handleException(Exception ex) { ... }
}
```
- **获取用户资料接口**
```java
@GetMapping("/profile/{userId}")
public ApiResponse<UserProfileDTO> getProfile(@PathVariable Long userId) {
    UserProfileDTO dto = userService.getUserProfileDTO(userId);
    if (dto == null) {
        return new ApiResponse<>(404, "用户信息不存在", null);
    }
    return new ApiResponse<>(200, "获取成功", dto);
}
```
- **更新用户资料接口**
```java
@PutMapping("/profile/{userId}")
public ApiResponse<Void> updateProfile(@PathVariable Long userId,
                                       @RequestBody UserProfileDTO userProfileDTO) {
    boolean ok = userService.updateUserProfile(userId, userProfileDTO);
    return ok ? new ApiResponse<>(200, "更新成功", null)
            : new ApiResponse<>(400, "更新失败", null);
}
```

---

## 8. 前后端通信数据格式示例

### 8.1 获取用户资料接口
- **请求地址**：`GET /api/user/profile/1`
- **响应体示例**（成功）：
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": {
    "id": 1,
    "nickname": "测试昵称",
    "avatarUrl": "https://example.com/avatar.png",
    "backgroundUrl": "https://example.com/bg.png",
    "gender": "M"
  }
}
```
- **响应体示例**（失败）：
```json
{
  "code": 404,
  "msg": "用户信息不存在",
  "data": null
}
```

### 8.2 更新用户资料接口
- **请求地址**：`PUT /api/user/profile/1`
- **请求体示例**（JSON）：
```json
{
  "nickname": "新昵称",
  "avatarUrl": "https://example.com/newavatar.png",
  "backgroundUrl": "https://example.com/newbg.png",
  "gender": "F"
}
```
- **响应体示例**（成功）：
```json
{
  "code": 200,
  "msg": "更新成功",
  "data": null
}
```
- **响应体示例**（失败）：
```json
{
  "code": 400,
  "msg": "更新失败",
  "data": null
}
```

---

## 9. 总结

用户资料相关接口遵循统一的分层设计和响应规范，具备良好的可维护性和扩展性。全局异常处理和统一响应格式保证了前后端通信的健壮性和一致性。

