# 博客系统后端接口与结构说明（2025-11-28）

## 1. 项目结构与分层

- **controller**：接收前端请求、参数校验、调用 service、返回统一响应。
- **service**：封装业务逻辑，处理数据、权限、流程控制，调用 repository。
- **repository**：数据访问层，负责与数据库交互（JPA/Mapper）。
- **model**：实体类，映射数据库表结构。
- **dto**：数据传输对象，前后端交互的数据结构。
- **mapper**：实体与 DTO 互转。
- **common**：通用工具、统一响应、异常处理、JWT 工具等。
- **config**：安全配置等。

## 2. 分层协作与解耦

- controller 只依赖 service 和 dto，不涉及数据库和实体。
- service 只依赖 repository、model、dto、mapper，业务逻辑集中，便于测试和维护。
- repository 只负责数据持久化，接口化，便于替换和单元测试。
- dto/mapper 负责数据结构转换，避免实体泄漏到 controller 层。
- common 层提供统一响应、异常处理、工具类，所有层可复用。
- config 层集中管理安全、跨域等配置。

## 3. 主要接口设计（按模块分组）

### 博客相关（BlogPostController）
| 方法 | 路径 | 说明 | 请求体/参数 | 返回 |
|------|------|------|-------------|------|
| POST | /api/blogpost | 创建博客 | BlogPostCreateDTO | ApiResponse<Long> |
| GET | /api/blogpost/{id} | 获取单篇博客详情 | id | ApiResponse<BlogPostDTO> |
| GET | /api/blogpost | 分页获取博客列表 | page, size, currentUserId | ApiResponse<PageResult<BlogPostDTO>> |
| POST | /api/blogpost/{id}/like | 点赞/取消点赞 | id, userId | ApiResponse<Boolean> |
| POST | /api/blogpost/comment | 发表评论 | CommentCreateDTO | ApiResponse<Long> |
| GET | /api/blogpost/{id}/comments | 分页获取博客评论 | id, page, size, currentUserId | ApiResponse<PageResult<CommentDTO>> |
| POST | /api/blogpost/comment/{id}/like | 评论点赞/取消点赞 | id, userId | ApiResponse<Boolean> |
| POST | /api/blogpost/repost | 转发博客 | RepostCreateDTO | ApiResponse<Long> |
| PUT | /api/blogpost/{id} | 更新博客 | id, BlogPostUpdateDTO | ApiResponse<Boolean> |

### 用户相关（UserController）
| 方法 | 路径 | 说明 | 请求体/参数 | 返回 |
|------|------|------|-------------|------|
| POST | /api/user/register | 用户注册 | UserRegisterDTO | ApiResponse<Void> |
| POST | /api/user/login | 用户登录 | UserLoginDTO | ApiResponse<LoginResponseDTO> |
| GET | /api/user/profile/{userId} | 获取用户资料 | userId | ApiResponse<UserProfileDTO> |
| PUT | /api/user/profile/{userId} | 更新用户资料 | userId, UserProfileDTO | ApiResponse<Void> |

### 评论相关（CommentController）
| 方法 | 路径 | 说明 | 请求体/参数 | 返回 |
|------|------|------|-------------|------|
| POST | /api/comment | 新增评论 | CommentCreateDTO | ApiResponse<Long> |
| GET | /api/comment/list/{blogPostId} | 分页获取评论列表 | blogPostId, page, size, currentUserId | ApiResponse<PageResult<CommentDTO>> |
| DELETE | /api/comment/{commentId} | 删除评论 | commentId, userId | ApiResponse<Boolean> |
| POST | /api/comment/{commentId}/like | 点赞/取消点赞 | commentId, userId | ApiResponse<Boolean> |

### 私信相关（PrivateMessageController）
| 方法 | 路径 | 说明 | 请求体/参数 | 返回 |
|------|------|------|-------------|------|
| POST | /api/messages/text/{otherId} | 发送文本私信 | PrivateMessageDTO | ApiResponse<PrivateMessageDTO> |
| POST | /api/messages/media/{otherId} | 发送媒体私信 | PrivateMessageDTO | ApiResponse<PrivateMessageDTO> |
| GET | /api/messages/conversation/{otherId} | 分页获取会话历史 | otherId, page, size | ApiResponse<PageResult<PrivateMessageDTO>> |

### 关注相关（FollowController）
| 方法 | 路径 | 说明 | 请求体/参数 | 返回 |
|------|------|------|-------------|------|
| POST | /api/follow/{targetId} | 关注用户 | targetId | ApiResponse<Void> |
| DELETE | /api/follow/{targetId} | 取关用户 | targetId | ApiResponse<Void> |
| GET | /api/follow/followers | 获取粉丝列表 | page, size | ApiResponse<PageResult<UserSearchDTO>> |
| GET | /api/follow/following | 获取关注列表 | page, size | ApiResponse<PageResult<UserSearchDTO>> |
| GET | /api/follow/friends/{otherId} | 判断互相关注 | otherId | ApiResponse<Boolean> |

### 好友搜索相关（UserSearchController）
| 方法 | 路径 | 说明 | 请求体/参数 | 返回 |
|------|------|------|-------------|------|
| GET | /api/users/search | 分页搜索用户 | username/nickname, page, size | ApiResponse<PageResult<UserSearchDTO>> |

---

## 4. 统一数据传输结构（DTO/VO）示例

### PageResult<T>
```json
{
  "list": [ ... ],
  "total": 100,
  "page": 0,
  "size": 10
}
```

### BlogPostDTO
```json
{
  "id": 1,
  "title": "string",
  "content": "string",
  "coverImageUrl": "url",
  "directory": "string",
  "likeCount": 10,
  "commentCount": 5,
  "shareCount": 1,
  "repostCount": 0,
  "createdAt": "2025-11-27T12:00:00Z",
  "updatedAt": "2025-11-27T12:00:00Z",
  "repost": false,
  "originalPostId": null,
  "likedByCurrentUser": true,
  "authorNickname": "昵称",
  "authorAvatarUrl": "头像URL"
}
```

### CommentDTO
```json
{
  "id": 1,
  "blogPostId": 1,
  "userId": 2,
  "content": "评论内容",
  "createdAt": "2025-11-28T12:00:00",
  "likeCount": 3,
  "likedByCurrentUser": true,
  "nickname": "用户昵称",
  "avatarUrl": "头像URL"
}
```

### UserProfileDTO
```json
{
  "id": 1,
  "nickname": "昵称",
  "avatarUrl": "头像URL",
  "backgroundUrl": "背景URL",
  "gender": "男/女"
}
```

### LoginResponseDTO
```json
{
  "token": "jwt-token-string",
  "userId": 1,
  "nickname": "昵称",
  "avatarUrl": "头像URL",
  "backgroundUrl": "背景URL",
  "gender": "男/女"
}
```

### UserSearchDTO
```json
{
  "id": 1,
  "username": "string",
  "gender": "男/女",
  "nickname": "昵称",
  "avatarUrl": "头像URL"
}
```

### PrivateMessageDTO
```json
{
  "id": 123,
  "senderId": 1,
  "receiverId": 2,
  "text": "你好！",
  "mediaUrl": null,
  "type": "TEXT",
  "createdAt": "2025-11-28T12:34:56Z"
}
```

---

## 5. 统一响应结构（ApiResponse）

所有接口返回如下结构：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": "具体DTO对象或null"
}
```

---

## 6. 分页、幂等、权限、异常处理
- 所有列表接口均支持分页（page/size/total），统一 PageResult<T>。
- 点赞、评论、删除等操作均幂等，防止重复操作。
- 敏感操作（如删除、资料更新）均有权限校验。
- 全局异常由 GlobalExceptionHandler 统一处理，参数校验失败自动返回 400，业务异常抛出 BusinessException。
- 未知异常返回 500，避免敏感信息泄漏。

---

## 7. 典型代码片段

### ApiResponse
```java
public class ApiResponse<T> {
    private int code;
    private String msg;
    private T data;
    // ...getter/setter...
}
```

### 全局异常处理
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ApiResponse<Void> handleValidationException(MethodArgumentNotValidException ex) { ... }
    @ExceptionHandler(BusinessException.class)
    public ApiResponse<Void> handleBusinessException(BusinessException ex) { ... }
    @ExceptionHandler(Exception.class)
    public ApiResponse<Void> handleException(Exception ex) { ... }
}
```

### JWT 生成
```java
public static String generateToken(Long userId, String username) {
    return Jwts.builder()
        .setSubject(username)
        .claim("userId", userId)
        .setIssuedAt(new Date())
        .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION))
        .signWith(key)
        .compact();
}
```

---

## 8. 分层协作流程

1. 前端发起请求（如获取/创建/更新/删除等）。
2. Controller 接收请求，参数校验。
3. Service 执行业务逻辑（如查库、权限校验、数据封装）。
4. DTO/Mapper 用于数据传递与转换。
5. Repository 负责数据库操作。
6. Common 层提供工具与统一响应。
7. 异常由全局处理器统一捕获。
8. Controller 返回统一格式响应给前端。

---

如需详细代码实现，请查阅对应 Java 文件。
