# 搜索好友模块详细说明

本说明文档基于当前后端实现，全面梳理“搜索好友”相关功能、接口、数据结构、分层设计、分页、幂等性、权限校验、异常处理等。

---

## 1. 业务逻辑与结构

- 支持通过用户名或昵称模糊搜索用户。
- 支持分页获取搜索结果，返回总数，便于前端分页展示。
- 搜索结果仅暴露必要信息，防止敏感信息泄漏。
- 可与关注、私信等社交模块联动。

---

## 2. 主要实体与DTO结构

### 2.1 User 实体
- id: Long
- username: String
- gender: String

### 2.2 UserProfile 实体
- id: Long
- user: User
- nickname: String
- avatarUrl: String

### 2.3 UserSearchDTO
```json
{
  "id": 1,
  "username": "string",
  "gender": "男/女",
  "nickname": "昵称",
  "avatarUrl": "头像URL"
}
```

### 2.4 PageResult<UserSearchDTO>
```json
{
  "list": [UserSearchDTO, ...],
  "total": 100,
  "page": 0,
  "size": 10
}
```

---

## 3. 主要接口设计（UserSearchController）

| 方法 | 路径 | 说明 | 请求体/参数 | 返回 |
|------|------|------|-------------|------|
| GET | /api/users/search | 分页搜索用户 | username/nickname, page, size | ApiResponse<PageResult<UserSearchDTO>> |

---

## 4. Service 层接口

```java
public interface UserSearchService {
    List<Object[]> searchByUsernameWithProfile(String username, int page, int size);
    List<Object[]> searchByNicknameWithProfile(String nickname, int page, int size);
    long countByUsername(String username);
    long countByNickname(String nickname);
}
```

---

## 5. 主要实现逻辑说明
- 支持用户名、昵称任意一个参数模糊搜索。
- 分页查询，返回总数，便于前端分页展示。
- 结果通过 UserSearchMapper 转换为 UserSearchDTO，避免实体泄漏。

---

## 6. Controller 典型代码片段

```java
@RestController
public class UserSearchController {
    private final UserSearchService userSearchService;
    public UserSearchController(UserSearchService userSearchService) {
        this.userSearchService = userSearchService;
    }
    @GetMapping("/api/users/search")
    public ApiResponse<PageResult<UserSearchDTO>> search(
            @RequestParam(required = false) String username,
            @RequestParam(required = false) String nickname,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size) {
        List<Object[]> list;
        long total;
        if (username != null && !username.isBlank()) {
            list = userSearchService.searchByUsernameWithProfile(username, page, size);
            total = userSearchService.countByUsername(username);
        } else if (nickname != null && !nickname.isBlank()) {
            list = userSearchService.searchByNicknameWithProfile(nickname, page, size);
            total = userSearchService.countByNickname(nickname);
        } else {
            return new ApiResponse<>(400, "参数缺失：需提供 username 或 nickname", null);
        }
        List<UserSearchDTO> dtoList = list.stream()
                .map(arr -> UserSearchMapper.toDTO((User) arr[0], (UserProfile) arr[1]))
                .toList();
        return new ApiResponse<>(200, "OK", new PageResult<>(dtoList, total, page, size));
    }
}
```

---

## 7. 幂等性、权限、异常处理
- 搜索操作无副作用，天然幂等。
- 所有接口返回统一 ApiResponse<T>，包含 code/msg/data。
- 全局异常由 GlobalExceptionHandler 统一处理，参数校验失败自动返回 400，业务异常抛出 BusinessException。

---

## 8. 其他说明
- 支持后续扩展（如多条件搜索、标签、排序等）。
- 可与关注、私信等社交模块联动。

---

如需详细代码实现，请查阅 `service/impl/UserSearchServiceImpl.java`、`controller/UserSearchController.java`、`model/User.java`、`model/UserProfile.java`、`dto/UserSearchDTO.java`、`repository/UserRepository.java` 等文件。
