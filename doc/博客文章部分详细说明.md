# 博客文章模块详细说明

本说明文档基于当前后端实现，全面梳理博客文章（BlogPost）相关功能、接口、数据结构、分层设计、幂等性、权限校验、异常处理等。

---

## 1. 业务逻辑与结构

- 支持用户创建、获取、更新、删除博客文章。
- 支持分页获取博客列表，返回总数，便于前端分页展示。
- 支持点赞/取消点赞、评论、转发等操作，均为幂等。
- 博客作者信息（昵称、头像）通过 UserProfile 关联获取。
- 敏感操作（如更新、删除）需校验权限。

---

## 2. 主要实体与DTO结构

### 2.1 BlogPost 实体
- id: Long
- title: String
- content: String
- author: User
- coverImageUrl: String
- directory: String
- likeCount: Long
- commentCount: Long
- shareCount: Long
- repostCount: Long
- createdAt: LocalDateTime
- updatedAt: LocalDateTime
- repost: Boolean
- originalPostId: Long

### 2.2 BlogPostCreateDTO
```json
{
  "title": "string",
  "content": "string",
  "userId": 1,
  "coverImageUrl": "url",
  "directory": "string"
}
```

### 2.3 BlogPostDTO
```json
{
  "id": 1,
  "title": "string",
  "content": "string",
  "coverImageUrl": "url",
  "directory": "string",
  "likeCount": 10,
  "commentCount": 5,
  "shareCount": 1,
  "repostCount": 0,
  "createdAt": "2025-11-27T12:00:00Z",
  "updatedAt": "2025-11-27T12:00:00Z",
  "repost": false,
  "originalPostId": null,
  "likedByCurrentUser": true,
  "authorNickname": "昵称",
  "authorAvatarUrl": "头像URL"
}
```

### 2.4 BlogPostUpdateDTO
```json
{
  "title": "string",
  "content": "string"
}
```

### 2.5 PageResult<BlogPostDTO>
```json
{
  "list": [BlogPostDTO, ...],
  "total": 100,
  "page": 0,
  "size": 10
}
```

---

## 3. 主要接口设计（BlogPostController）

| 方法 | 路径 | 说明 | 请求体/参数 | 返回 |
|------|------|------|-------------|------|
| POST | /api/blogpost | 创建博客 | BlogPostCreateDTO | ApiResponse<Long> |
| GET | /api/blogpost/{id} | 获取博客详情 | id | ApiResponse<BlogPostDTO> |
| GET | /api/blogpost | 分页获取博客列表 | page, size, currentUserId | ApiResponse<PageResult<BlogPostDTO>> |
| POST | /api/blogpost/{id}/like | 点赞/取消点赞 | id, userId | ApiResponse<Boolean> |
| POST | /api/blogpost/comment | 发表评论 | CommentCreateDTO | ApiResponse<Long> |
| GET | /api/blogpost/{id}/comments | 分页获取博客评论 | id, page, size, currentUserId | ApiResponse<PageResult<CommentDTO>> |
| POST | /api/blogpost/comment/{id}/like | 评论点赞/取消点赞 | id, userId | ApiResponse<Boolean> |
| POST | /api/blogpost/repost | 转发博客 | RepostCreateDTO | ApiResponse<Long> |
| PUT | /api/blogpost/{id} | 更新博客 | id, BlogPostUpdateDTO | ApiResponse<Boolean> |

---

## 4. Service 层接口

```java
public interface BlogPostService {
    ApiResponse<Long> create(BlogPostCreateDTO dto);
    BlogPostDTO getById(Long id, Long currentUserId);
    PageResult<BlogPostDTO> list(int page, int size, Long currentUserId);
    ApiResponse<Boolean> toggleLike(Long blogPostId, Long userId);
    ApiResponse<Long> addComment(CommentCreateDTO dto);
    PageResult<CommentDTO> listComments(Long blogPostId, int page, int size, Long currentUserId);
    ApiResponse<Boolean> toggleCommentLike(Long commentId, Long userId);
    ApiResponse<Long> repost(RepostCreateDTO dto);
    boolean update(Long id, BlogPostUpdateDTO dto, Long userId);
}
```

---

## 5. 主要实现逻辑说明
- **create**：校验参数，保存博客，初始化计数。
- **getById**：获取博客详情，补充作者昵称、头像、当前用户点赞状态。
- **list**：分页查询博客列表，补充作者信息、点赞状态。
- **toggleLike/toggleCommentLike**：判断是否已点赞，幂等处理，更新计数。
- **addComment/listComments**：评论相关，见评论模块。
- **repost**：转发博客，记录原始博客。
- **update**：校验权限，仅作者本人可更新。

---

## 6. Controller 典型代码片段

```java
@RestController
@RequestMapping("/api/blogpost")
public class BlogPostController {
    @Autowired
    private BlogPostService blogPostService;

    @PostMapping
    public ApiResponse<Long> create(@RequestBody BlogPostCreateDTO dto) {
        return blogPostService.create(dto);
    }

    @GetMapping("/{id}")
    public ApiResponse<BlogPostDTO> getById(@PathVariable Long id, @RequestParam(required = false) Long currentUserId) {
        return new ApiResponse<>(200, "获取成功", blogPostService.getById(id, currentUserId));
    }

    @GetMapping
    public ApiResponse<PageResult<BlogPostDTO>> list(@RequestParam(defaultValue = "0") int page,
                                                    @RequestParam(defaultValue = "10") int size,
                                                    @RequestParam(required = false) Long currentUserId) {
        return new ApiResponse<>(200, "获取成功", blogPostService.list(page, size, currentUserId));
    }

    // ... 其他接口同上 ...
}
```

---

## 7. 幂等性、权限、异常处理
- 点赞/取消点赞、评论、转发、更新等操作均幂等，防止重复操作。
- 更新、删除等敏感操作需校验用户身份，仅作者本人可操作。
- 所有接口返回统一 ApiResponse<T>，包含 code/msg/data。
- 全局异常由 GlobalExceptionHandler 统一处理，参数校验失败自动返回 400，业务异常抛出 BusinessException。

---

## 8. 其他说明
- 博客作者信息通过 UserProfile 关联获取，DTO 仅暴露必要字段。
- 支持后续扩展（如博客分组、标签、置顶、草稿等）。

---

如需详细代码实现，请查阅 `service/impl/BlogPostServiceImpl.java`、`controller/BlogPostController.java`、`model/BlogPost.java`、`dto/BlogPostDTO.java`、`repository/BlogPostRepository.java` 等文件。
