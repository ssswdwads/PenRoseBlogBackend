# 博客文章部分详细说明

本说明文档详细分析本项目后端关于博客文章相关功能的实现机制，涵盖通信流程、文件间交互、前后端链接、全局异常处理以及ApiResponse统一格式、各个层次之间各自的功能以及通信连接的过程。内容参考了《登录注册部分详细说明》和《用户资料部分详细说明》，并结合实际代码实现。

---

## 1. 通信流程与前后端链接

### 1.1 获取博客文章列表流程
- **前端**向`/api/blog/list`发送GET请求，可带分页参数。
- **后端**`BlogPostController`接收请求，调用`BlogPostService.listBlogPosts()`获取文章列表。
- 返回统一格式的`ApiResponse<List<BlogPostDTO>>`，code为200，msg为“获取成功”。

### 1.2 获取单篇博客文章详情流程
- **前端**向`/api/blog/{postId}`发送GET请求，路径参数为文章ID。
- **后端**`BlogPostController`接收请求，调用`BlogPostService.getBlogPostDTO(postId)`获取详情。
- 若文章存在，返回`ApiResponse<BlogPostDTO>`，否则返回404和提示信息。

### 1.3 创建博客文章流程
- **前端**向`/api/blog/create`发送POST请求，Body为JSON格式的`BlogPostCreateDTO`（包含标题、内容等）。
- **后端**`BlogPostController`接收请求，调用`BlogPostService.createBlogPost(blogPostCreateDTO)`进行业务处理。
- 创建成功后，返回`ApiResponse<Void>`，code为200，msg为“创建成功”；失败则返回400和提示信息。

### 1.4 更新/删除博客文章流程
- **前端**向`/api/blog/update/{postId}`发送PUT请求，Body为`BlogPostUpdateDTO`。
- **后端**`BlogPostController`接收请求，调用`BlogPostService.updateBlogPost(postId, blogPostUpdateDTO)`。
- 删除则为DELETE请求，调用`BlogPostService.deleteBlogPost(postId)`。
- 操作成功返回统一格式，失败返回相应错误码和信息。

---

## 2. 文件间交互与各层功能

### 2.1 Controller层
- 负责接收前端请求、参数校验、调用Service层、返回统一响应。
- 主要文件：`BlogPostController.java`
  - 负责`/api/blog`相关接口的路由与响应。

### 2.2 Service层
- 负责业务逻辑处理，如文章的增删改查、分页、权限校验等。
- 主要文件：`BlogPostService.java`、`BlogPostServiceImpl.java`
  - `listBlogPosts()`：分页查询文章列表，封装为DTO。
  - `getBlogPostDTO(postId)`：根据ID查询文章详情。
  - `createBlogPost(blogPostCreateDTO)`：创建新文章。
  - `updateBlogPost(postId, blogPostUpdateDTO)`：更新文章。
  - `deleteBlogPost(postId)`：删除文章。

### 2.3 DTO层
- 用于数据传输和参数校验。
- 主要文件：
  - `BlogPostDTO.java`：文章详情与列表返回结构。
  - `BlogPostCreateDTO.java`：创建文章参数。
  - `BlogPostUpdateDTO.java`：更新文章参数。

### 2.4 Repository/Mapper层
- 负责数据库操作。
- 主要文件：
  - `BlogPostRepository.java`：JPA接口，提供文章的增删改查。

### 2.5 Common层
- 提供通用工具和统一响应、异常处理。
- 主要文件：
  - `ApiResponse.java`：统一API响应格式。
  - `GlobalExceptionHandler.java`：全局异常处理。
  - `BusinessException.java`：业务异常。

---

## 3. 统一API响应格式（ApiResponse）
- 所有接口返回`ApiResponse<T>`对象，包含：
  - `code`：状态码（如200、400、404等）
  - `msg`：提示信息
  - `data`：数据内容（如文章DTO，创建/删除无数据则为null）
- 便于前端统一处理响应。

---

## 4. 全局异常处理
- `GlobalExceptionHandler`统一处理参数校验异常、业务异常、未知异常。
- 参数校验失败时，自动返回400和详细错误信息。
- 业务异常（如文章不存在、无权限等）抛出`BusinessException`，由全局异常处理器捕获并返回友好提示。
- 未知异常返回500和通用错误信息，避免泄露敏感信息。

---

## 5. 各层通信与流程图解

1. **前端**发起请求（获取/创建/更新/删除博客文章）
2. **Controller**接收请求，参数校验
3. **Service**执行业务逻辑（如查库、权限校验、数据封装）
4. **DTO**用于数据传递与校验
5. **Repository/Mapper**负责数据库操作
6. **Common**层提供工具与统一响应
7. **异常**由全局处理器统一捕获
8. **Controller**返回统一格式响应给前端

---

## 6. 形象说明

- **获取文章流程**：
  1. 前端请求文章列表或详情
  2. 后端查找文章，封装DTO
  3. 返回数据或不存在提示

- **创建/更新/删除流程**：
  1. 前端填写内容，发起操作
  2. 后端校验、执行业务、操作数据库
  3. 返回成功或失败原因

- **异常处理**：
  - 格式错误、业务冲突、系统异常均有详细提示，前端可据此友好展示

- **统一响应**：
  - 所有接口返回结构一致，便于前端统一处理

---

## 7. 关键代码片段举例

- **ApiResponse**
```java
public class ApiResponse<T> {
    private int code;
    private String msg;
    private T data;
    // ...getter/setter/静态工厂方法...
}
```

- **全局异常处理**
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(BusinessException.class)
    public ApiResponse<Void> handleBusinessException(BusinessException ex) {
        return ApiResponse.error(ex.getCode(), ex.getMessage());
    }
    // ...参数校验/未知异常处理...
}
```

- **Controller与Service调用**
```java
@RestController
@RequestMapping("/api/blog")
public class BlogPostController {
    @Autowired
    private BlogPostService blogPostService;

    @GetMapping("/list")
    public ApiResponse<List<BlogPostDTO>> listBlogPosts(...) {
        return ApiResponse.success(blogPostService.listBlogPosts(...));
    }
    // ...其他接口...
}
```

---

## 8. 前后端数据格式示例

### 8.1 创建博客文章
- **前端请求Body（BlogPostCreateDTO）**
```json
{
  "title": "我的第一篇博客",
  "content": "这是正文内容",
  "userId": 1,
  "coverImageUrl": "https://example.com/cover.jpg",
  "directory": "技术/Java"
}
```
- **后端响应（ApiResponse<Long>）**
```json
{
  "code": 200,
  "msg": "创建成功",
  "data": 123
}
```

### 8.2 获取博客文章详情
- **后端响应（ApiResponse<BlogPostDTO>）**
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": {
    "id": 123,
    "title": "我的第一篇博客",
    "userId": 1,
    "coverImageUrl": "https://example.com/cover.jpg",
    "content": "这是正文内容",
    "directory": "技术/Java",
    "likeCount": 10,
    "commentCount": 2,
    "shareCount": 1,
    "repostCount": 0,
    "createdAt": "2025-11-27T10:00:00",
    "updatedAt": "2025-11-27T10:00:00",
    "repost": false,
    "originalPostId": null,
    "likedByCurrentUser": true
  }
}
```

### 8.3 评论相关
- **前端请求Body（CommentCreateDTO）**
```json
{
  "blogPostId": 123,
  "userId": 2,
  "content": "写得很好！"
}
```
- **后端响应（ApiResponse<Long>）**
```json
{
  "code": 200,
  "msg": "评论成功",
  "data": 456
}
```

### 8.4 获取评论列表
- **后端响应（ApiResponse<List<CommentDTO>>）**
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": [
    {
      "id": 456,
      "blogPostId": 123,
      "userId": 2,
      "content": "写得很好！",
      "createdAt": "2025-11-27T10:10:00",
      "likeCount": 3,
      "likedByCurrentUser": false,
      "nickname": "小明",
      "avatarUrl": "https://example.com/avatar.jpg"
    }
  ]
}
```

---

## 9. Controller与Service详细说明与接口设计

### 9.1 Controller层（BlogPostController）
负责接收前端请求、参数校验、调用Service层、返回统一响应。

主要接口设计如下：

- `POST /api/blogpost` 创建博客文章
  - 请求体：BlogPostCreateDTO
  - 返回：ApiResponse<Long>（新建博客ID）
- `GET /api/blogpost/{id}` 获取博客详情
  - 路径参数：id
  - 返回：ApiResponse<BlogPostDTO>
- `GET /api/blogpost` 获取博客列表
  - 查询参数：page, size, currentUserId
  - 返回：ApiResponse<List<BlogPostDTO>>
- `POST /api/blogpost/{id}/like` 点赞/取消点赞
  - 路径参数：id，查询参数：userId
  - 返回：ApiResponse<Boolean>
- `POST /api/blogpost/comment` 发表评论
  - 请求体：CommentCreateDTO
  - 返回：ApiResponse<Long>（评论ID）
- `GET /api/blogpost/{id}/comments` 获取评论列表
  - 路径参数：id，查询参数：currentUserId
  - 返回：ApiResponse<List<CommentDTO>>
- `POST /api/blogpost/comment/{id}/like` 评论点赞/取消点赞
  - 路径参数：id，查询参数：userId
  - 返回：ApiResponse<Boolean>
- `POST /api/blogpost/repost` 转发博客
  - 请求体：RepostCreateDTO
  - 返回：ApiResponse<Long>（新博客ID）

### 9.2 Service层（BlogPostService）
负责业务逻辑处理，如文章的增删改查、评论、点赞、转发等。

主要方法说明：

- `ApiResponse<Long> create(BlogPostCreateDTO dto)`：创建博客，返回新ID。
- `BlogPostDTO getById(Long id)`：根据ID获取博客详情。
- `boolean update(Long id, BlogPostUpdateDTO dto)`：更新博客内容。
- `ApiResponse<Boolean> toggleLike(Long blogPostId, Long userId)`：点赞或取消点赞。
- `ApiResponse<Boolean> toggleCommentLike(Long commentId, Long userId)`：评论点赞或取消点赞。
- `ApiResponse<Long> addComment(CommentCreateDTO dto)`：添加评论。
- `List<CommentDTO> listComments(Long blogPostId, Long currentUserId)`：获取评论列表。
- `List<BlogPostDTO> list(int page, int size, Long currentUserId)`：分页获取博客列表。
- `ApiResponse<Long> repost(RepostCreateDTO dto)`：转发博客。

---

如需更详细的代码实现，请参考`src/main/java/com/kirisamemarisa/blog/controller/BlogPostController.java`及相关Service、DTO、Repository文件。
