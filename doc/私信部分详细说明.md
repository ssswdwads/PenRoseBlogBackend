# 私信模块详细说明

本说明文档基于当前后端实现，全面梳理私信（PrivateMessage）相关功能、接口、数据结构、分层设计、分页、幂等性、权限校验、异常处理、SSE推送等。

---

## 1. 业务逻辑与结构

- 支持用户间一对一私信聊天，支持文本、图片、视频等多媒体消息。
- 支持分页获取会话历史，返回总数，便于前端分页展示。
- 支持SSE实时推送消息。
- 非好友首次仅允许发送一条文本，需对方回复后才能继续。
- 所有操作有权限校验，防止越权。

---

## 2. 主要实体与DTO结构

### 2.1 PrivateMessage 实体
- id: Long
- sender: User
- receiver: User
- text: String
- mediaUrl: String
- type: MessageType (TEXT/IMAGE/VIDEO)
- createdAt: Instant

### 2.2 PrivateMessageDTO
```json
{
  "id": 123,
  "senderId": 1,
  "receiverId": 2,
  "text": "你好！",
  "mediaUrl": null,
  "type": "TEXT",
  "createdAt": "2025-11-28T12:34:56Z"
}
```

### 2.3 PageResult<PrivateMessageDTO>
```json
{
  "list": [PrivateMessageDTO, ...],
  "total": 100,
  "page": 0,
  "size": 20
}
```

---

## 3. 主要接口设计（PrivateMessageController）

| 方法 | 路径 | 说明 | 请求体/参数 | 返回 |
|------|------|------|-------------|------|
| POST | /api/messages/text/{otherId} | 发送文本私信 | PrivateMessageDTO | ApiResponse<PrivateMessageDTO> |
| POST | /api/messages/media/{otherId} | 发送媒体私信 | PrivateMessageDTO | ApiResponse<PrivateMessageDTO> |
| GET | /api/messages/conversation/{otherId} | 分页获取会话历史 | otherId, page, size | ApiResponse<PageResult<PrivateMessageDTO>> |
| GET | /api/messages/stream | SSE实时推送 | userId | SSE流 |

---

## 4. Service 层接口

```java
public interface PrivateMessageService {
    PrivateMessage sendText(User sender, User receiver, String text);
    PrivateMessage sendMedia(User sender, User receiver, PrivateMessage.MessageType type, String mediaUrl, String caption);
    List<PrivateMessage> conversation(User a, User b);
    boolean canSendMedia(User sender, User receiver);
    boolean hasReplied(User sender, User receiver);
}
```

---

## 5. 主要实现逻辑说明
- **sendText**：非好友首次仅允许发送一条文本，需对方回复后才能继续。
- **sendMedia**：需互相关注或对方已回复。
- **conversation**：获取双方所有历史消息，按时间排序。
- **SSE推送**：新消息实时推送给双方。

---

## 6. Controller 典型代码片段

```java
@RestController
@RequestMapping("/api/messages")
public class PrivateMessageController {
    @Autowired
    private PrivateMessageService privateMessageService;
    @Autowired
    private UserRepository userRepository;
    @Autowired
    private MessageEventPublisher publisher;

    @GetMapping("/conversation/{otherId}")
    public ApiResponse<PageResult<PrivateMessageDTO>> conversation(@PathVariable Long otherId,
                                                             @RequestParam(defaultValue = "0") int page,
                                                             @RequestParam(defaultValue = "20") int size,
                                                             @RequestHeader(name = "X-User-Id", required = false) Long headerUserId,
                                                             @AuthenticationPrincipal UserDetails principal) {
        // ...权限校验与分页逻辑见实现...
    }

    @PostMapping("/text/{otherId}")
    public ApiResponse<PrivateMessageDTO> sendText(@PathVariable Long otherId,
                                                   @RequestBody PrivateMessageDTO body,
                                                   @RequestHeader(name = "X-User-Id", required = false) Long headerUserId,
                                                   @AuthenticationPrincipal UserDetails principal) {
        // ...权限校验与推送逻辑见实现...
    }

    @PostMapping("/media/{otherId}")
    public ApiResponse<PrivateMessageDTO> sendMedia(@PathVariable Long otherId,
                                                    @RequestBody PrivateMessageDTO body,
                                                    @RequestHeader(name = "X-User-Id", required = false) Long headerUserId,
                                                    @AuthenticationPrincipal UserDetails principal) {
        // ...权限校验与推送逻辑见实现...
    }
}
```

---

## 7. 幂等性、权限、异常处理
- 非好友首次仅允许发送一条文本，幂等校验。
- 所有操作需校验用户身份，防止越权。
- 所有接口返回统一 ApiResponse<T>，包含 code/msg/data。
- 全局异常由 GlobalExceptionHandler 统一处理，参数校验失败自动返回 400，业务异常抛出 BusinessException。

---

## 8. 其他说明
- 支持后续扩展（如群聊、消息撤回、已读回执等）。
- DTO 仅暴露必要字段，防止敏感信息泄漏。

---

如需详细代码实现，请查阅 `service/impl/PrivateMessageServiceImpl.java`、`controller/PrivateMessageController.java`、`model/PrivateMessage.java`、`dto/PrivateMessageDTO.java`、`repository/PrivateMessageRepository.java` 等文件。
