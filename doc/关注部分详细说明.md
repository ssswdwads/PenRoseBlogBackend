# 关注模块详细说明

本说明文档基于当前后端实现，全面梳理关注（Follow）相关功能、接口、数据结构、分层设计、幂等性、权限校验、异常处理等。

---

## 1. 业务逻辑与结构

- 支持用户关注/取关其他用户，获取粉丝/关注列表，判断互相关注。
- 支持分页获取粉丝/关注列表，返回总数，便于前端分页展示。
- 关注/取关操作幂等，防止重复关注、重复取关。
- 关注、取关、获取列表等操作均有权限校验。

---

## 2. 主要实体与DTO结构

### 2.1 Follow 实体
- id: Long
- follower: User
- followee: User
- createdAt: LocalDateTime

### 2.2 FollowDTO
```json
{
  "id": 1,
  "followerId": 2,
  "followeeId": 3,
  "createdAt": "2025-11-28T12:00:00"
}
```

### 2.3 UserSearchDTO（用于粉丝/关注列表）
```json
{
  "id": 1,
  "username": "string",
  "gender": "男/女",
  "nickname": "昵称",
  "avatarUrl": "头像URL"
}
```

### 2.4 PageResult<UserSearchDTO>
```json
{
  "list": [UserSearchDTO, ...],
  "total": 100,
  "page": 0,
  "size": 10
}
```

---

## 3. 主要接口设计（FollowController）

| 方法 | 路径 | 说明 | 请求体/参数 | 返回 |
|------|------|------|-------------|------|
| POST | /api/follow/{targetId} | 关注用户 | targetId | ApiResponse<Void> |
| DELETE | /api/follow/{targetId} | 取关用户 | targetId | ApiResponse<Void> |
| GET | /api/follow/followers | 分页获取粉丝列表 | page, size | ApiResponse<PageResult<UserSearchDTO>> |
| GET | /api/follow/following | 分页获取关注列表 | page, size | ApiResponse<PageResult<UserSearchDTO>> |
| GET | /api/follow/friends/{otherId} | 判断互相关注 | otherId | ApiResponse<Boolean> |

---

## 4. Service 层接口

```java
public interface FollowService {
    ApiResponse<Void> follow(Long followerId, Long followeeId);
    ApiResponse<Void> unfollow(Long followerId, Long followeeId);
    PageResult<UserSearchDTO> listFollowers(Long userId, int page, int size);
    PageResult<UserSearchDTO> listFollowing(Long userId, int page, int size);
    boolean areFriends(Long userId, Long otherId);
}
```

---

## 5. 主要实现逻辑说明
- **follow/unfollow**：校验参数，防止重复关注/取关，幂等处理。
- **listFollowers/listFollowing**：分页查询粉丝/关注列表，补充用户昵称、头像。
- **areFriends**：判断双方是否互相关注。

---

## 6. Controller 典型代码片段

```java
@RestController
@RequestMapping("/api/follow")
public class FollowController {
    @Autowired
    private FollowService followService;

    @PostMapping("/{targetId}")
    public ApiResponse<Void> follow(@PathVariable Long targetId, @RequestParam Long userId) {
        return followService.follow(userId, targetId);
    }

    @DeleteMapping("/{targetId}")
    public ApiResponse<Void> unfollow(@PathVariable Long targetId, @RequestParam Long userId) {
        return followService.unfollow(userId, targetId);
    }

    @GetMapping("/followers")
    public ApiResponse<PageResult<UserSearchDTO>> listFollowers(@RequestParam Long userId,
                                                               @RequestParam(defaultValue = "0") int page,
                                                               @RequestParam(defaultValue = "10") int size) {
        return new ApiResponse<>(200, "获取成功", followService.listFollowers(userId, page, size));
    }

    @GetMapping("/following")
    public ApiResponse<PageResult<UserSearchDTO>> listFollowing(@RequestParam Long userId,
                                                               @RequestParam(defaultValue = "0") int page,
                                                               @RequestParam(defaultValue = "10") int size) {
        return new ApiResponse<>(200, "获取成功", followService.listFollowing(userId, page, size));
    }

    @GetMapping("/friends/{otherId}")
    public ApiResponse<Boolean> areFriends(@RequestParam Long userId, @PathVariable Long otherId) {
        return new ApiResponse<>(200, "操作成功", followService.areFriends(userId, otherId));
    }
}
```

---

## 7. 幂等性、权限、异常处理
- 关注/取关等操作均幂等，防止重复操作。
- 敏感操作需校验用户身份。
- 所有接口返回统一 ApiResponse<T>，包含 code/msg/data。
- 全局异常由 GlobalExceptionHandler 统一处理，参数校验失败自动返回 400，业务异常抛出 BusinessException。

---

## 8. 其他说明
- 支持后续扩展（如关注通知、分组、备注、批量关注等）。
- DTO 仅暴露必要字段，防止敏感信息泄漏。

---

如需详细代码实现，请查阅 `service/impl/FollowServiceImpl.java`、`controller/FollowController.java`、`model/Follow.java`、`dto/FollowDTO.java`、`repository/FollowRepository.java` 等文件。
