# 评论模块详细说明

本说明文档基于当前后端实现，全面梳理评论（Comment）相关功能、接口、数据结构、分层设计、幂等性、权限校验、异常处理等。

---

## 1. 业务逻辑与结构

- 支持用户在博客下发布评论、删除自己评论、对评论点赞/取消点赞。
- 支持分页获取评论列表，返回总数，便于前端分页展示。
- 每条评论关联一个博客（BlogPost）和一个用户（User），支持统计评论的点赞数和评论数。
- 点赞操作幂等，防止重复点赞。
- 删除评论需校验权限，仅允许作者本人删除。

---

## 2. 主要实体与DTO结构

### 2.1 Comment 实体
- id: Long
- blogPost: BlogPost
- user: User
- content: String
- createdAt: LocalDateTime
- likeCount: Long

### 2.2 CommentCreateDTO
```json
{
  "blogPostId": 1,
  "userId": 2,
  "content": "评论内容"
}
```

### 2.3 CommentDTO
```json
{
  "id": 1,
  "blogPostId": 1,
  "userId": 2,
  "content": "评论内容",
  "createdAt": "2025-11-28T12:00:00",
  "likeCount": 3,
  "likedByCurrentUser": true,
  "nickname": "用户昵称",
  "avatarUrl": "头像URL"
}
```

### 2.4 PageResult<CommentDTO>
```json
{
  "list": [CommentDTO, ...],
  "total": 100,
  "page": 0,
  "size": 10
}
```

---

## 3. 主要接口设计（CommentController）

| 方法 | 路径 | 说明 | 请求体/参数 | 返回 |
|------|------|------|-------------|------|
| POST | /api/comment | 新增评论 | CommentCreateDTO | ApiResponse<Long> |
| GET | /api/comment/list/{blogPostId} | 分页获取评论列表 | blogPostId, page, size, currentUserId | ApiResponse<PageResult<CommentDTO>> |
| DELETE | /api/comment/{commentId} | 删除评论 | commentId, userId | ApiResponse<Boolean> |
| POST | /api/comment/{commentId}/like | 点赞/取消点赞 | commentId, userId | ApiResponse<Boolean> |

---

## 4. Service 层接口

```java
public interface CommentService {
    ApiResponse<Long> addComment(CommentCreateDTO dto);
    List<CommentDTO> listComments(Long blogPostId, Long currentUserId);
    PageResult<CommentDTO> pageComments(Long blogPostId, int page, int size, Long currentUserId);
    ApiResponse<Boolean> deleteComment(Long commentId, Long userId);
    ApiResponse<Boolean> toggleLike(Long commentId, Long userId);
}
```

---

## 5. 主要实现逻辑说明
- **addComment**：校验参数，保存评论，更新博客评论数。
- **listComments/pageComments**：查询评论列表，补充用户昵称、头像、当前用户点赞状态，支持分页与总数。
- **deleteComment**：校验权限，仅允许作者本人删除，删除后同步更新博客评论数。
- **toggleLike**：判断是否已点赞，已点赞则取消，否则点赞，幂等处理，更新评论点赞数。

---

## 6. Controller 典型代码片段

```java
@RestController
@RequestMapping("/api/comment")
public class CommentController {
    @Autowired
    private CommentService commentService;

    @PostMapping
    public ApiResponse<Long> addComment(@RequestBody CommentCreateDTO dto) {
        return commentService.addComment(dto);
    }

    @GetMapping("/list/{blogPostId}")
    public ApiResponse<PageResult<CommentDTO>> listComments(@PathVariable Long blogPostId,
                                                           @RequestParam(defaultValue = "0") int page,
                                                           @RequestParam(defaultValue = "10") int size,
                                                           @RequestParam(required = false) Long currentUserId) {
        return new ApiResponse<>(200, "获取成功", commentService.pageComments(blogPostId, page, size, currentUserId));
    }

    @DeleteMapping("/{commentId}")
    public ApiResponse<Boolean> deleteComment(@PathVariable Long commentId, @RequestParam Long userId) {
        return commentService.deleteComment(commentId, userId);
    }

    @PostMapping("/{commentId}/like")
    public ApiResponse<Boolean> toggleLike(@PathVariable Long commentId, @RequestParam Long userId) {
        return commentService.toggleLike(commentId, userId);
    }
}
```

---

## 7. 幂等性、权限、异常处理
- 点赞/取消点赞、删除评论等操作均幂等，防止重复操作。
- 删除评论需校验用户身份，仅作者本人可删。
- 所有接口返回统一 ApiResponse<T>，包含 code/msg/data。
- 全局异常由 GlobalExceptionHandler 统一处理，参数校验失败自动返回 400，业务异常抛出 BusinessException。

---

## 8. 其他说明
- 评论数、点赞数等数据在相关操作中同步更新，保证数据一致性。
- DTO 仅暴露必要字段，防止敏感信息泄漏。
- 支持后续扩展（如评论回复、@用户、敏感词过滤等）。

---

如需详细代码实现，请查阅 `service/impl/CommentServiceImpl.java`、`controller/CommentController.java`、`model/Comment.java`、`dto/CommentDTO.java`、`repository/CommentRepository.java` 等文件。
