# 评论部分详细说明

## 1. 业务逻辑与结构

评论（Comment）功能允许用户在博客文章下发布评论、删除自己的评论、点赞/取消点赞评论，并可获取评论列表。每条评论关联一个博客文章（BlogPost）和一个用户（User），支持统计评论的点赞数和评论数。

### 1.1 主要实体结构
- **Comment**：评论实体，包含内容、作者、所属博客、点赞数、创建时间等。
- **CommentLike**：评论点赞实体，记录用户对评论的点赞行为，防止重复点赞。

### 1.2 主要表结构
- `comment`：存储评论信息。
- `comment_like`：存储评论点赞信息，唯一约束（comment_id, user_id）。

## 2. 主要功能
- **添加评论**：用户可在博客下发布评论。
- **删除评论**：用户可删除自己发布的评论。
- **评论点赞/取消点赞**：用户可对评论点赞���取消点赞。
- **获取评论列表**：按时间倒序获取指定博客下的所有评论，支持返回当前用户是否点赞。

## 3. 前后端接口

### 3.1 添加评论
- **URL**：`POST /api/comment`
- **请求体**：
```json
{
  "blogPostId": 1,
  "userId": 2,
  "content": "评论内容"
}
```
- **响应**：
```json
{
  "code": 200,
  "msg": "评论成功",
  "data": 123
}
```

### 3.2 获取评论列表
- **URL**：`GET /api/comment/list/{blogPostId}?currentUserId=2`
- **响应**：
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": [
    {
      "id": 1,
      "blogPostId": 1,
      "userId": 2,
      "content": "评论内容",
      "createdAt": "2024-06-01T12:00:00",
      "likeCount": 3,
      "likedByCurrentUser": true,
      "nickname": "用户昵称",
      "avatarUrl": "头像URL"
    }
  ]
}
```

### 3.3 删除评论
- **URL**：`DELETE /api/comment/{commentId}?userId=2`
- **响应**：
```json
{
  "code": 200,
  "msg": "删除成功",
  "data": true
}
```

### 3.4 点赞/取消点赞
- **URL**：`POST /api/comment/{commentId}/like?userId=2`
- **响应**：
```json
{
  "code": 200,
  "msg": "点赞成功",
  "data": true
}
```
或
```json
{
  "code": 200,
  "msg": "取消点赞",
  "data": false
}
```

## 4. 数据结构

### 4.1 CommentCreateDTO
```java
public class CommentCreateDTO {
    private Long blogPostId;
    private Long userId;
    private String content;
    // getter/setter
}
```

### 4.2 CommentDTO
```java
public class CommentDTO {
    private Long id;
    private Long blogPostId;
    private Long userId;
    private String content;
    private LocalDateTime createdAt;
    private Long likeCount;
    private Boolean likedByCurrentUser;
    private String nickname;
    private String avatarUrl;
    // getter/setter
}
```

## 5. Service 层

### 5.1 接口定义
```java
public interface CommentService {
    ApiResponse<Long> addComment(CommentCreateDTO dto);
    List<CommentDTO> listComments(Long blogPostId, Long currentUserId);
    ApiResponse<Boolean> deleteComment(Long commentId, Long userId);
    ApiResponse<Boolean> toggleLike(Long commentId, Long userId);
}
```

### 5.2 主要实现逻辑
- **addComment**：校验参数，保存评论，更新博客评论数。
- **listComments**：查询评论列表，补充用户昵称、头像、当前用户点赞状态。
- **deleteComment**：校验权限，仅允许作者删除，删除评论并更新博客评论数。
- **toggleLike**：判断是否已点赞，已点赞则取消，否则点赞，并更新评论点赞数。

## 6. Controller 层

### 6.1 路由与方法
- `@PostMapping` `/api/comment`：添加评论。
- `@GetMapping` `/api/comment/list/{blogPostId}`：获取评论列表。
- `@DeleteMapping` `/api/comment/{commentId}`：删除评论。
- `@PostMapping` `/api/comment/{commentId}/like`：点赞/取消点赞。

### 6.2 典型代码
```java
@RestController
@RequestMapping("/api/comment")
public class CommentController {
    @Autowired
    private CommentService commentService;

    @PostMapping
    public ApiResponse<Long> addComment(@RequestBody CommentCreateDTO dto) {
        return commentService.addComment(dto);
    }

    @GetMapping("/list/{blogPostId}")
    public ApiResponse<List<CommentDTO>> listComments(@PathVariable Long blogPostId, @RequestParam(required = false) Long currentUserId) {
        List<CommentDTO> list = commentService.listComments(blogPostId, currentUserId);
        return new ApiResponse<>(200, "获取成功", list);
    }

    @DeleteMapping("/{commentId}")
    public ApiResponse<Boolean> deleteComment(@PathVariable Long commentId, @RequestParam Long userId) {
        return commentService.deleteComment(commentId, userId);
    }

    @PostMapping("/{commentId}/like")
    public ApiResponse<Boolean> toggleLike(@PathVariable Long commentId, @RequestParam Long userId) {
        return commentService.toggleLike(commentId, userId);
    }
}
```

## 7. 其他说明
- **异常处理**：统一由`GlobalExceptionHandler`处理参数校验、业务异常和未知异常。
- **点赞唯一性**：`CommentLike`表通过唯一约束防止重复点赞。
- **数据一致性**：评论数、点赞数均在相关操作中同步更新。

---
如需详细代码实现，请参考 `service/impl/CommentServiceImpl.java`、`controller/CommentController.java`、`model/Comment.java`、`model/CommentLike.java`、`dto/CommentCreateDTO.java`、`dto/CommentDTO.java`、`repository/CommentRepository.java`、`repository/CommentLikeRepository.java` 等文件。
