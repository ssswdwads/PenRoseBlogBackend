# 登录注册部分详细说明

本说明文档详细分析了本项目后端关于用户登录与注册的实现机制，涵盖通信流程、文件间交互、前后端链接、全局异常处理、统一API响应格式，以及各层次的功能与通信过程。

---

## 1. 通信流程与前后端链接

### 1.1 注册流程
- **前端**向`/api/user/register`发送POST请求，Body为JSON格式的`UserRegisterDTO`（包含用户名、密码、性别）。
- **后端**`UserController`接收请求，参数通过`@RequestBody @Valid`自动校验。
- 校验通过后，调用`UserService.register()`进行业务处理。
- 注册成功后，返回统一格式的`ApiResponse<Void>`，code为200，msg为“注册成功”。

### 1.2 登录流程
- **前端**向`/api/user/login`发送POST请求，Body为JSON格式的`UserLoginDTO`（用户名、密码）。
- **后端**`UserController`接收请求，参数同样通过`@RequestBody @Valid`校验。
- 校验通过后，调用`UserService.login()`，验证用户名和密码。
- 验证成功后，生成JWT令牌，封装为`LoginResponseDTO`，返回统一格式的`ApiResponse<LoginResponseDTO>`，code为200，msg为“登录成功”。

---

## 2. 文件间交互与各层功能

### 2.1 Controller层
- 负责接收前端请求、参数校验、调用Service层、返回统一响应。
- 主要文件：`UserController.java`

### 2.2 Service层
- 负责业务逻辑处理，如注册校验、密码加密、用户查找、JWT生成等。
- 主要文件：`UserService.java`

### 2.3 DTO层
- 用于数据传输和参数校验。
- 主要文件：
  - `UserLoginDTO.java`：登录参数
  - `UserRegisterDTO.java`：注册参数
  - `LoginResponseDTO.java`：登录响应

### 2.4 Common层
- 提供通用工具和统一响应、异常处理。
- 主要文件：
  - `ApiResponse.java`：统一API响应格式
  - `GlobalExceptionHandler.java`：全局异常处理
  - `JwtUtil.java`：JWT令牌生成与解析

---

## 3. 统一API响应格式（ApiResponse）
- 所有接口返回`ApiResponse<T>`对象，包含：
  - `code`：状态码（如200、400等）
  - `msg`：提示信息
  - `data`：数据内容（如登录返回token等，注册无数据则为null）
- 便于前端统一处理响应。

---

## 4. 全局异常处理
- `GlobalExceptionHandler`统一处理参数校验异常、业务异常、未知异常。
- 参数校验失败（如用户名、密码格式不符）时，自动返回400和详细错误信息。
- 业务异常（如用户名已存在、密码错误等）抛出`BusinessException`，由全局异常处理器捕获并返回友好提示。
- 未知异常返回500和通用错误信息，避免泄露敏感信息。

---

## 5. 各层通信与流程图解

1. **前端**发起请求（注册/登录）
2. **Controller**接收请求，参数校验
3. **Service**执行业务逻辑（如查库、加密、生成token）
4. **DTO**用于数据传递与校验
5. **Repository/Mapper**负责数据库操作（未详细展开）
6. **Common**层提供工具与统一响应
7. **异常**由全局处理器统一捕获
8. **Controller**返回统一格式响应给前端

---

## 6. 形象说明

- **注册流程**：
  1. 前端填写用户名、密码、性别，点击注册
  2. 后端校验格式、查重、加密密码，保存用户
  3. 返回注册成功或失败原因

- **登录流程**：
  1. 前端输入用户名、密码，点击登录
  2. 后端查找用户、校验密码，生成JWT
  3. 返回token及用户信息，前端保存token用于后续鉴权

- **异常处理**：
  - 格式错误、业务冲突、系统异常均有详细提示，前端可据此友好展示

- **统一响应**：
  - 所有接口返回结构一致，便于前端统一处理

---

## 7. 关键代码片段举例

- **ApiResponse**
```java
public class ApiResponse<T> {
    private int code;
    private String msg;
    private T data;
    // ... 构造方法、getter/setter ...
}
```
- **全局异常处理**
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ApiResponse<Void> handleValidationException(MethodArgumentNotValidException ex) { ... }
    @ExceptionHandler(BusinessException.class)
    public ApiResponse<Void> handleBusinessException(BusinessException ex) { ... }
    @ExceptionHandler(Exception.class)
    public ApiResponse<Void> handleException(Exception ex) { ... }
}
```
- **JWT生成**
```java
public static String generateToken(Long userId, String username) {
    return Jwts.builder()
        .setSubject(username)
        .claim("userId", userId)
        .setIssuedAt(new Date())
        .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION))
        .signWith(key)
        .compact();
}
```

---

## 8. 前后端通信数据格式示例

### 8.1 注册接口
- **请求地址**：`POST /api/user/register`
- **请求体示例**（JSON）：
```json
{
  "username": "testuser",
  "password": "abc12345",
  "gender": "M"
}
```
- **响应体示例**（成功）：
```json
{
  "code": 200,
  "msg": "注册成功",
  "data": null
}
```
- **响应体示例**（失败，如用户名已存在）：
```json
{
  "code": 400,
  "msg": "用户名已存在",
  "data": null
}
```

### 8.2 登录接口
- **请求地址**：`POST /api/user/login`
- **请求体示例**（JSON）：
```json
{
  "username": "testuser",
  "password": "abc12345"
}
```
- **响应体示例**（成功）：
```json
{
  "code": 200,
  "msg": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userId": 1,
    "nickname": "测试昵称",
    "avatarUrl": "https://example.com/avatar.png",
    "backgroundUrl": "https://example.com/bg.png",
    "gender": "M"
  }
}
```
- **响应体示例**（失败，如密码错误）：
```json
{
  "code": 400,
  "msg": "密码错误",
  "data": null
}
```

---

## 9. Controller接口设计与Service处理逻辑

### 9.1 UserController接口设计

`UserController` 负责用户相关的接口暴露，主要包括注册、登录、获取用户信息等。

#### 1. 注册接口
- **方法签名**：
  ```java
  @PostMapping("/register")
  public ApiResponse<Void> register(@RequestBody @Valid UserRegisterDTO userRegisterDTO)
  ```
- **说明**：
  - 接收前端注册请求，参数为`UserRegisterDTO`，自动校验格式。
  - 调用`userService.register(userRegisterDTO)`执行业务逻辑。
  - 注册成功返回`ApiResponse<Void>`，code=200。

#### 2. 登录接口
- **方法签名**：
  ```java
  @PostMapping("/login")
  public ApiResponse<LoginResponseDTO> login(@RequestBody @Valid UserLoginDTO userLoginDTO)
  ```
- **说明**：
  - 接收前端登录请求，参数为`UserLoginDTO`，自动校验格式。
  - 调用`userService.login(userLoginDTO)`执行业务逻辑。
  - 登录成功返回`ApiResponse<LoginResponseDTO>`，包含token和用户信息。

#### 3. 获取用户信息接口
- **方法签名**：
  ```java
  @GetMapping("/profile/{userId}")
  public ApiResponse<UserProfileDTO> getProfile(@PathVariable Long userId)
  ```
- **说明**：
  - 根据用户ID获取用户详细信息。
  - 调用`userService.getUserProfileDTO(userId)`。

---

### 9.2 UserService处理逻辑

`UserService` 负责用户相关的业务逻辑处理。

#### 1. 注册逻辑
- **方法签名**：
  ```java
  public void register(UserRegisterDTO dto)
  ```
- **处理流程**：
  1. 校验请求体是否为空。
  2. 校验用户名格式（5-15位字母数字下划线）。
  3. 校验密码格式（8-12位，必须包含字母和数字）。
  4. 检查用户名是否已存在。
  5. 使用`UserMapper`将DTO转为User实体，密码加密后保存到数据库。

#### 2. 登录逻辑
- **方法签名**：
  ```java
  public LoginResponseDTO login(UserLoginDTO dto)
  ```
- **处理流程**：
  1. 校验请求体是否为空。
  2. 校验用户名和密码是否为空。
  3. 查询数据库，判断用户是否存在。
  4. 校验密码是否正确（BCrypt加密比对）。
  5. 生成JWT token。
  6. 查询用户Profile信息，组装`LoginResponseDTO`返回。

#### 3. 获取用户信息逻辑
- **方法签名**：
  ```java
  public UserProfileDTO getUserProfileDTO(Long userId)
  ```
- **处理流程**：
  1. 校验userId是否为空。
  2. 查询用户Profile，使用`UserProfileMapper`转为DTO。

---

如需更详细的流程图或代码解读，请联系开发者。
